<div class="d-flex justify-content-between align-items-center bg-light p-2">
    <div class="btn-group" role="group" aria-label="Admin menu">
      <button type="button" class="btn btn-outline-primary" (click)="neteja(1)" [ngClass]="{ 'd-none': id_usuari != 0 }">Registrar-se</button>
      <button type="button" class="btn btn-outline-primary" (click)="neteja(3)" [ngClass]="{ 'd-none': id_usuari === 0 }">Actulitzar-se</button>
      <button type="button" class="btn btn-outline-primary" (click)="neteja(2)">Identificar-se</button>      
    </div>  
    <button type="button" class="btn btn-outline-danger" (click)="tornar()">Sortir</button>
</div>

<div class="btn-group" role="group" aria-label="Admin menu">
  <div [ngClass]="id_usuari === 0 ? 'ms-2 p-2 text-danger bg-dark rounded d-inline-block' : 'ms-2 p-2 bg-dark text-warning rounded d-inline-block'">
      {{ usuari }}
  </div>
  <div>
    <button type="button" class="ms-2 btn btn-success" (click)="reserva()" [ngClass]="{ 'd-none': id_usuari === 0 }" (click)="reserva()">Nova Reserva</button>
  </div>
</div>

<hr>

<div class="d-flex justify-content-center">
    @for (sala of sales; track sala.id; let id_sala = $index) {
      <button class="col-md-1 border border-secondary rounded ms-2 p-2 text-center" [ngStyle]="{ 'background-color': sala.color }" (click)="getSala( sala.id )">{{sala.descripcio}}</button>
    }
</div>


<hr>

  <div class='container mt-4'>
    <full-calendar [options]='calendarOptions()'>
      <ng-template #eventContent let-arg>
        <b>{{ arg.timeText }}</b>
        <i>{{ arg.event.title }}</i>
      </ng-template>
    </full-calendar>
  </div>


  <!-- Modal Login -->
  <div class="modal fade" id="loginModal" tabindex="-1" [ngClass]="{ 'show d-block': modalVisible[2] }">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar Sessió</h5>
          <button type="button" class="btn-close btn-close-white" (click)="tancarModal()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="onLoginSubmit()" #loginForm="ngForm">
            <div class="row">
              <div class="col-md-12">
                <label class="form-label">Correu electrònic</label>
                <input type="email" class="form-control" name="loginData.email" id="loginData.email" [(ngModel)]="loginData.email">
              </div>              
            </div>  
            <div class="row">
              <div class="col-md-6">                                  
                <label class="form-label">Contrasenya</label>
                <input type="password" class="form-control" name="loginData.password" id="loginData.password" [(ngModel)]="loginData.password">
              </div>         
            </div>
            <hr>
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Entrar</button>
                <button type="button" class="btn btn-danger" (click)="tancarModal()">Sortir</button>            
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Registro Insert o Update -->
  <div class="modal fade" tabindex="-1" [ngClass]="{ 'show d-block': modalVisible[1] || modalVisible[3] }">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">{{ finestra == 1 ? 'Registrar-se' : 'Actulitzar-se' }}</h5>
          <button type="button" class="btn-close btn-close-white" (click)="tancarModal()"></button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="onRegisterSubmit()"  #Registreform="ngForm">
            <div class="row">
              <div class="col-md-12">
                <label class="form-label">Nom</label>
                <input type="email" class="form-control" [(ngModel)]="registerData.nom"                
                       required minlength="3" maxlength="50" 
                       #nomField="ngModel"
                       name="nom" id="nom">
                       @if(nomField.invalid && nomField.touched) {      
                         @if(nomField.errors?.['required']) {
                           <div class="invalido">Ompli el nom.</div>
                         }
                         @if(nomField.errors?.['minlength']) {
                           <div class="invalido">Mínim obligat. {{ nomField.errors?.['minlength'].requiredLength }}</div>
                         }
                         @if(nomField.errors?.['maxlength']) {
                           <div class="invalido">Màxim obligat. {{ nomField.errors?.['maxlength'].requiredLength }}</div>
                         }    
                       }            
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">                        
                <label class="form-label">Correu electrònic</label>
                <input type="email" class="form-control" [(ngModel)]="registerData.email"
                       required minlength="3" maxlength="50" 
                       #emailField="ngModel"
                       name="email" id="email">
                       @if(emailField.invalid && emailField.touched) {      
                          @if(emailField.errors?.['required']) {
                            <div class="invalido">Ompli el correu electrònic.</div>
                          }
                          @if(emailField.errors?.['minlength']) {
                            <div class="invalido">Mínim obligat. {{ emailField.errors?.['minlength'].requiredLength }}</div>
                          }
                          @if(emailField.errors?.['maxlength']) {
                            <div class="invalido">Màxim obligat. {{ emailField.errors?.['maxlength'].requiredLength }}</div>
                          }    
                       }            
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">                                                
                <label class="form-label">Contrasenya</label>
                <input type="password" class="form-control" [(ngModel)]="registerData.password"
                       required minlength="3" maxlength="8" 
                       #passwordField="ngModel"
                       name="password" id="password">
              </div>
              <div class="col-md-6">
                <label class="form-label">Confirmar contrasenya</label>
                <input type="password" class="form-control" [(ngModel)]="registerData.confirm"
                      #confirmField="ngModel"
                      name="confirm" id="confirm">              
              </div>     
              
              @if(passwordField.invalid && passwordField.touched) {      
                @if(passwordField.errors?.['required']) {
                  <div class="invalido">Ompli la contrasenya.</div>
                }
                @if(passwordField.errors?.['minlength']) {
                  <div class="invalido">Mínim obligat. {{ emailField.errors?.['minlength'].requiredLength }}</div>
                }
                @if(passwordField.errors?.['maxlength']) {
                  <div class="invalido">Màxim obligat. {{ emailField.errors?.['maxlength'].requiredLength }}</div>
                }    
              }            

              <div *ngIf="confirmField.touched && !passwordsMatch()" class="text-danger mt-1">
                   <div class="invalido">Las contrasenyes no coincideixen.</div>
              </div>
            </div>
            <hr> 
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-success mr-2" [disabled]="!Registreform.valid || !passwordsMatch()">{{ finestra == 1 ? 'Registrar-se' : 'Actulitzar-se' }}</button>
                <button type="button" class="btn btn-danger" (click)="tancarModal()">Sortir</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Sala -->
  <div class="modal fade" id="salaModal" tabindex="-1" [ngClass]="{ 'show d-block': modalVisible[99] }">
    <div class="modal-dialog">
      <div class="modal-content bg-warning">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Sala</h5>
          <button type="button" class="btn-close btn-close-white" (click)="tancarModal()"></button>
        </div>
        <div class="modal-body">
          <form>            
            <div class="modal-body">
              <div class="row">
                <div class="col-md-12">
                  <label>Nom</label>
                  <input type="text" class="form-control" [(ngModel)]="salaSeleccionado.descripcio" disabled name="descripcio" id="descripcio">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <label>Edifici</label>
                  <input type="text" class="form-control" [(ngModel)]="salaSeleccionado.nom_edifici" disabled name="nom_edifici" id="nom_edifici">
                </div>
              </div>
              <div class="row">
                <div class="col-md-3">
                  <label>Aforament</label>
                  <input type="text" class="form-control" [(ngModel)]="salaSeleccionado.max_ocupacio" disabled name="max" id="max">
                </div>       
                <div class="col-md-4">
                  <label>Horari</label>
                  <select class="form-select" [(ngModel)]="salaSeleccionado.horari" name="horari" id="horari" disabled>
                        <option value="1">1 hora</option>
                        <option value="2">½ hora</option>
                  </select>
                </div>         
                <div class="col-md-3">
                  <label>{{ salaSeleccionado.horari == '2' ? 'Preu ½ hora' : 'Preu hora' }}</label>
                  <input type="text" class="form-control" [(ngModel)]="salaSeleccionado.preu" disabled name="preu" id="preu">
                </div>                                                
              </div>
              @if(salaSeleccionado.missatge) {
                <div class="row border rounded mt-4 bg-danger p-2">
                  <div class="col-md-12">                    
                    <h5>{{ salaSeleccionado.missatge }}</h5>
                  </div>
                </div>
              }  
            </div>
            <hr>
            <div class="col-md-12">                                              
                  <table class="table table-striped table-bordered">
                      <thead class="table-dark">
                        <tr>        
                          <th>Complement</th>
                          <th>Preu</th>
                        </tr>
                      </thead>
                      <tbody>
                          @for(comple of complements;  track comple.id; let id_comple = $index) {
                            <tr>        
                                <td class="w-40">{{ comple.descripcio }}</td>      
                                <td class="w-10 text-end">{{ comple.preu | PipePreu }} €</td>
                            </tr>
                          }
                      </tbody>
                  </table>
            </div>
            <hr>
            <div class="d-flex justify-content-between">               
                <button type="button" class="btn btn-danger" (click)="tancarModal()">Sortir</button>            
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


<!-- Reserva modal -->
<div class="modal fade" tabindex="-1" [ngClass]="{ 'show d-block':  modalVisible[90] }">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Reserva Sala</h5>
        <button type="button" class="btn-close" (click)="tancarModal()"></button>
      </div>

      <div class="modal-body container-fluid">                
              <div class="row">
                <div class="col-md-3 mr-2"> 
                  <div class="form-group">
                    <label for="fecha">Data:</label>                    
                    <input type="date" class="form-control" id="data_reserva" name="data_reserva" [(ngModel)]="data_reserva" size=10 required>
                  </div>
                </div>
                <div class="col-md-4 mr-2"> 
                  <div class="form-group">
                     <label for="sala">Sala:</label>
                     <select class="form-control" id="sala_reserva" name="sala_reserva" required [(ngModel)]="sala_reserva" (change)="actualizarMaximo()">
                        @for (sala of sales; track sala.id; let id_sala = $index) {
                          <option value="{{ sala.id}}"> {{ sala.descripcio }}</option>'
                        }
                     </select>
                   </div>
                </div>                
                <div class="col-md-3 mr-2"> 
                  <label>&nbsp;</label>
                  <input class="form-control btn btn-warning mr-2" id="generate" type="button" value="Cercar Hores" (click)="generate()"/>			     		                         
                </div>
                <div class="col-md-2 mr-2"> 
                  <label>&nbsp;</label>                  
                  <button type="button" class="form-control btn btn-danger" (click)="tancarModal()">Sortir</button>
                </div>
              </div>
              <div class="row">
                <div class="col-md-2 mr-2"> 
                    <label for="fecha">Aforament:</label>                    
                    <input type="input" class="form-control" id="max_sala" name="max_sala" [(ngModel)]="max_sala" size=5 disabled>
                </div>
                <div class="col-md-2 mr-2"> 
                    <label for="fecha">Horari:</label>        
                    <select class="form-select" [(ngModel)]="horari" name="horari" id="horari" disabled>
                          <option value="1">1 hora</option>
                          <option value="2">½ hora</option>
                    </select>                                                    
                </div>                
              </div>
              <div class="mt-3 container">
                     <div *ngIf="mostrarHourGrid">
                        @for(mira of mira_dia;track mira.id) {                         
                          <div class="row text-center">
                              @for(col of mira.items;track $index) {
                                <button class="col-md-2 d-flex p-2 rounded text-white m-1"
                                    #horesSelected
                                    name="horesSelected"
                                    [ngClass]="col.estado === 'No informado' ? 'bg-success' : 'bg-danger'"
                                    [disabled]="col.estado != 'No informado'" 
                                    (click)="triaHora($event)">                                
                                {{col.hora_inici}}
                                </button>
                              }                        
                          </div>
                        }                     
                     </div>
                     <hr>
                     <div class="row mb-2" id="extras">

                     </div>
              </div>
              <div class="modal-footer">
                  <div *ngIf="mostrarPeu">      
                        <h1>Preu {{ this.preu_sala_total | PipePreu }}</h1>                  
                        <button type="button" class="btn btn-primary m-2">Desar</button>
                        <button type="button" class="btn btn-secondary" (click)="tancarModal()">Cancel.lar</button>
                  </div>
              </div>          
      </div>
    </div>
  </div>
</div>    

<!-- Mostrar dia -->
<div class="modal fade" tabindex="-1" [ngClass]="{ 'show d-block':  modalVisible[80] }">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Dia {{ dia | PipeFecha }}</h5>
        <button type="button" class="btn-close" (click)="tancarModal()"></button>
      </div>
      <div class="modal-body container-fluid text-center">     
        <div class="row">
          @for(mira of mira_dia;track mira.id) {
            <div class="col-md-6">
               <strong>{{mira.id}}</strong>
                <div class="row">
                 @for(col of mira.items;track $index) {
                      <div class="col-md-3 d-flex p-2 rounded text-white m-1"
                         [ngClass]="col.estado === 'No informado' ? 'bg-success' : 'bg-danger'"
                      >
                        {{col.hora_inici}}
                      </div>
                  }
                </div>
           </div>                      
          }
        </div>   
        <hr>
        <div class="d-flex justify-content-between">               
             <button type="button" class="btn btn-danger" (click)="tancarModal()">Sortir</button>            
        </div>
      </div>    
    </div>
</div>
